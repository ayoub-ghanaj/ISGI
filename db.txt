DROP DATABASE isgiexams;
CREATE DATABASE isgiexams;

USE isgiexams;



create table matier(
    idm  INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
    nom VARCHAR(100));
create table filier(
    idf  INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
    nom VARCHAR(100));
    

     
     



CREATE TABLE users(
username varchar(40) primary key,
passw varchar(40) NOT null,
email varchar(200) UNIQUE,
rank varchar(30),
loger varchar(20),
sessions INT,
dated DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE table question(
    idq  varchar(255) PRIMARY KEY ,
    quest VARCHAR(1000),
    idf INT,
    idm INT,
    username varchar(40),
    FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE,
    FOREIGN KEY (idf) REFERENCES filier(idf) ON DELETE CASCADE,
    FOREIGN KEY (idm) REFERENCES matier(idm) ON DELETE CASCADE
);
create table respond(
idr  INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
chois varchar(550),
qcm  boolean,
idq varchar(255) ,
FOREIGN KEY (idq) REFERENCES question(idq) ON DELETE CASCADE );


CREATE TABLE batchexam(
idbat INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
code varchar(2800) UNIQUE,
username varchar(40),
header varchar(255) DEFAULT 'default',
idf INT,
idm INT,
FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE,
FOREIGN KEY (idf) REFERENCES filier(idf) ON DELETE CASCADE,
FOREIGN KEY (idm) REFERENCES matier(idm) ON DELETE CASCADE
);

CREATE TABLE exam(
idexam INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
code varchar(2800) UNIQUE,
username varchar(40),
idbat int ,
FOREIGN KEY (idbat) REFERENCES batchexam(idbat) ON DELETE CASCADE,
FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);

CREATE TABLE class(
idcls INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
numeleves INT ,
Nom varchar(30),
prof varchar(40),
FOREIGN KEY (prof) REFERENCES users(username) ON DELETE CASCADE 
);

CREATE TABLE eleves(
idele INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
idcls INT ,
Nom varchar(30),
eleve varchar(40),
FOREIGN KEY (eleve) REFERENCES users(username) ON DELETE CASCADE,
FOREIGN KEY (idcls) REFERENCES class(idcls) ON DELETE CASCADE
);

CREATE TABLE passed(
idpass INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
username varchar(40),
idbat int NOT null,
note  float ,
result varchar(200),
datepassed DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
FOREIGN KEY (idbat) REFERENCES batchexam(idbat) ON DELETE CASCADE,
FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);

CREATE TABLE assign(
idasg INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
idbat INT ,
idcls INT,
FOREIGN KEY (idcls) REFERENCES class(idcls) ON DELETE CASCADE ,
FOREIGN KEY (idbat) REFERENCES batchexam(idbat) ON DELETE CASCADE
);

create table pfpu(
idpfp INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
username varchar(40),
link varchar(2000),
datepf DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);

CREATE TABLE sessionu(
idses varchar(255) NOT NULL  PRIMARY KEY,
username varchar(40),
browser varchar(40),
ip varchar(100),
location varchar(1000),
os varchar(40),
dateses DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
devicname varchar(40),
stat int ,
FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);

DELIMITER $$
Create Procedure sp_sess (IN S_Name VARCHAR(40))
BEGIN
	UPDATE users SET sessions = sessions+1 WHERE username = S_Name;
	SELECT sessions FROM users WHERE username = S_Name;
END$$
DELIMITER ;

#CALL sp_sess('ayoub2g')




INSERT INTO `filier` (`idf`, `nom`) VALUES
(1, 'TDI'),
(2, 'TRI'),
(3, 'TCE'),
(4, 'TSD'),
(5, 'TSGE'),
(6, 'TSFC'),
(7, 'TSC');


INSERT INTO `matier` (`idm`, `nom`) VALUES
(1, 'SGDB');


INSERT INTO `question` (`idq`, `quest`, `idf`, `idm`, `username`) VALUES
(1, 'MySQL est un système de gestion de base de données _____?', 1, 1,'ayoubg'),
(2, 'À quoi correspondent les données d’une base de données MySQL?', 1, 1 ,'ayoubg'),
(3, 'MySQL est disponible gratuitement? Est-il open source ?', 1, 1 ,'ayoubg'),
(4, 'Comment la communication est-elle établie avec le serveur MySQL ?', 1, 1 ,'ayoubg'),
(5, 'Qu’est-ce qu’un tuple dans une base de données relationnelle ?', 1, 1 ,'ayoubg'),
(6, 'Qu’est-ce qui représente un attribut dans une base de données relationnelle ?', 1, 1 ,'ayoubg'),
(7, 'Quelle instruction est utilisée pour sélectionner une base de données par défaut?', 1, 1 ,'ayoubg'),
(8, 'Quel mot-clé est le synonyme de DATABASE?', 1, 1 ,'ayoubg'),
(9, 'Quel mot clé est utilisé pour créer une base de données?', 1, 1 ,'ayoubg'),
(10, 'Le fichier créé par le serveur pour stocker les attributs de la base de données est _____?', 1, 1 ,'ayoubg');





INSERT INTO `respond` (`idr`, `chois`, `qcm`, `idq`) VALUES
(1, 'Orienté objet', 0, 1),
(2, 'Hiérarchique', 0, 1),
(3, 'Relationnel', 1, 1),
(4, 'Réseau', 0, 1),
(5, 'Objets', 0, 2),
(6, 'Tables', 1, 2),
(7, 'Réseaux', 0, 2),
(8, 'Systèmes de fichiers', 0, 2),
(9, 'Vrai', 1, 3),
(10, 'Faux', 0, 3),
(11, 'SQL', 1, 4),
(12, 'Des appels réseau', 0, 4),
(13, 'Un langage de programmation comme C ++', 0, 4),
(14, 'APIs', 0, 4),
(15, 'Table', 0, 5),
(16, 'Ligne', 1, 5),
(17, 'Colonne', 0, 5),
(18, 'Objet', 0, 5),
(19, 'Table', 0, 6),
(20, 'Ligne', 0, 6),
(21, 'Colonne', 1, 6),
(22, 'Objet', 0, 6),
(23, 'USE', 1, 7),
(24, 'CREATE', 0, 7),
(25, 'DROP', 0, 7),
(26, 'SCHEMA', 0, 7),
(27, 'TABLE', 0, 8),
(28, 'OBJECT', 0, 8),
(29, 'DB', 0, 8),
(30, 'SCHEMA', 1, 8),
(31, 'CREATE', 1, 9),
(32, 'SET', 0, 9),
(33, 'SETUP', 0, 9),
(34, 'LINK', 0, 9),
(35, 'db.otp', 0, 10),
(36, 'dp.zip', 0, 10),
(37, 'db.opt', 1, 10),
(38, 'db.cls', 0, 10);

ALTER TABLE isgiexams.exam
  ADD COLUMN idbat INT,
  ADD FOREIGN KEY fk_idbat(idbat) REFERENCES batchexam(idbat) ON DELETE CASCADE;
  ALTER TABLE isgiexams.exam
  ADD COLUMN var INT;
CREATE table questionimg(
    idqmg INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    curl VARCHAR(1000),
    idf INT,
    idm INT,
    username varchar(40),
    FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE,
    FOREIGN KEY (idf) REFERENCES filier(idf) ON DELETE CASCADE,
    FOREIGN KEY (idm) REFERENCES matier(idm) ON DELETE CASCADE
);
CREATE table questiontxt(
    idqtxt INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    txt VARCHAR(3000),
    idf INT,
    idm INT,
    username varchar(40),
    FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE,
    FOREIGN KEY (idf) REFERENCES filier(idf) ON DELETE CASCADE,
    FOREIGN KEY (idm) REFERENCES matier(idm) ON DELETE CASCADE
);


CREATE TABLE examt2(
idexam INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
code varchar(2800) ,
    idf INT,
    idm INT,	
    username varchar(40),
    FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE,
    FOREIGN KEY (idf) REFERENCES filier(idf) ON DELETE CASCADE,
    FOREIGN KEY (idm) REFERENCES matier(idm) ON DELETE CASCADE
);